<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL      = 'https://bpxmqwgxjzphbavaikhq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJweG1xd2d4anpwaGJhdmFpa2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYyODI4MzIsImV4cCI6MjA2MTg1ODgzMn0.4Xqo2frDn8h09IZDSpDQdfv9LQO5g3tyPomHie0iAo0';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userEmailEl = document.getElementById('user-email');
  const logoutBtn   = document.getElementById('logout-btn');
  const tbody       = document.getElementById('projects-tbody');
  const createBtn   = document.getElementById('create-btn');
  const nameIn      = document.getElementById('proj-name');
  const codeIn      = document.getElementById('ai-code');
  const statusP     = document.getElementById('form-status');

  let user;

  async function init() {
    const { data } = await supabase.auth.getUser();
    user = data.user;
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    userEmailEl.textContent = user.email;
    loadProjects();
  }

  async function loadProjects() {
    tbody.innerHTML = '<tr><td colspan="3">Memuatkan…</td></tr>';
    const { data, error } = await supabase
      .from('projects')
      .select('title,code,created_at')
      .eq('email', user.email)
      .order('created_at', { ascending: false });

    if (error) {
      tbody.innerHTML = `<tr><td colspan="3">Ralat: ${error.message}</td></tr>`;
    } else if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3">Tiada projek lagi.</td></tr>';
    } else {
      tbody.innerHTML = data.map(p => `
        <tr>
          <td>${p.title}</td>
          <td>${p.code}</td>
          <td>${new Date(p.created_at).toLocaleString()}</td>
        </tr>
      `).join('');
    }
  }

  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'index.html';
  });

  createBtn.addEventListener('click', async () => {
    const title  = nameIn.value.trim();
    const aiCode = codeIn.value.trim();

    statusP.textContent = '';
    if (!title || !aiCode) {
      statusP.style.color = 'red';
      statusP.textContent = 'Sila isi nama projek dan kod AI anda.';
      return;
    }

    const slug = title
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      + '-' + Math.random().toString(36).slice(-4);

    // ← Insert termasuk ai_code
    const { error } = await supabase
      .from('projects')
      .insert({
        email:   user.email,
        title:   title,
        code:    slug,
        ai_code: aiCode
      })
      .select();

    if (error) {
      statusP.style.color = 'red';
      statusP.textContent = 'Gagal cipta projek: ' + error.message;
    } else {
      statusP.style.color = 'green';
      statusP.textContent = 'Berjaya! Kod projek: ' + slug;
      nameIn.value  = '';
      codeIn.value  = '';
      loadProjects();
    }
  });

  init();
</script>
